name: Fetch GitHub Issues and PRs

on:

  workflow_dispatch:
    inputs:
      repositories:
        description: "Comma-separated list of repositories in the format org/repo (e.g., org1/repo1,org2/repo2)"
        required: true

jobs:
  fetch-issues-prs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up jq
        run: sudo apt-get install -y jq

      - name: Parse input for repositories
        id: parse_input
        run: |
          REPOS="${{ github.event.inputs.repositories }}"
          echo "Repositories: $REPOS"
          echo "$REPOS" | jq -R 'split(",")' > repos.json
          cat repos.json

      - name: Fetch Issues and PRs
        env:
          GITHUB_PAT: ${{ secrets.SONA_TOKEN }}
        run: |
          REPOS=$(cat repos.json | jq -r '.[]')
          echo "Repositories: $REPOS"

          ISSUES_FILE="issues.csv"
          PRS_FILE="prs.csv"

          echo "Repository,Issue Number,Title,Created Date,Status,Creator,Labels,Assignees,Project,Issues URL,Milestone,Comments_count,Body,Close Date,Closed By,Last Updated" > $ISSUES_FILE
          echo "Repository,PR Number,Title,Created Date,Status,Creator,Labels,Assignees,PR URL,Comments_count,Body,Close Date,Closed By,Merged By,Last Updated" > $PRS_FILE

          for REPO_FULL in $REPOS; do
            ORG=$(echo "$REPO_FULL" | cut -d'/' -f1)
            REPO=$(echo "$REPO_FULL" | cut -d'/' -f2)
            echo "Processing: $ORG/$REPO"

            # Fetch issues
            PAGE=1
            ISSUE_FOUND=false
            while true; do
              RESPONSE=$(curl -s -H "Authorization: token $GITHUB_PAT" "https://api.github.com/repos/$ORG/$REPO/issues?state=all&per_page=100&page=$PAGE")
              echo "Page $PAGE Issues: $(echo "$RESPONSE" | jq '. | length')"

              if [[ $(echo "$RESPONSE" | jq '. | length') -eq 0 ]]; then
                if [[ $PAGE -eq 1 ]]; then
                  echo "$REPO,,,No issues found,,,,,,,,,," >> $ISSUES_FILE
                fi
                break
              fi

              ISSUE_FOUND=true
              echo "$RESPONSE" | jq -r --arg repo "$REPO" '
                .[] | select(.pull_request | not) |
                [
                  $repo,
                  (.number | tostring),
                  (.title // "No Title"),
                  (.created_at | split("T")[0]),
                  .state,
                  .user.login,
                  (if (.labels | length) == 0 then "None" else (.labels | map(.name) | join(";")) end),
                  (if (.assignees | length) == 0 then "None" else (.assignees | map(.login) | join(";")) end),
                  (.projects_url // "No Project"),
                  .html_url,
                  (.milestone.title // "No Milestone"),
                  (.comments | tostring),
                  (.body // "No Description" | gsub("\""; "\"\"") | gsub("\n"; " ")),
                  (.closed_at // "N/A"),
                  (.closed_by.login // "None"),
                  (.updated_at | split("T")[0])
                ] | @csv
              ' >> $ISSUES_FILE

              PAGE=$((PAGE + 1))
            done

            if [[ $ISSUE_FOUND == false ]]; then
              echo "$REPO,,,No issues found,,,,,,,,,," >> $ISSUES_FILE
            fi

          done

          echo "Final CSV Contents:"
          cat issues.csv

      - name: Check generated files
        run: ls -l

      - name: Print CSV contents
        run: head -n 10 issues.csv

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: issues-and-prs-reports
          path: "*.csv"
